<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="common/layout :: layout(~{::title}, ~{::section})">

<head>
    <title>个人中心 - Admin Pro</title>
</head>

<body>
    <section>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0 text-gray-800 fw-bold">个人中心</h4>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-white border-bottom-0 py-3">
                        <i class="fa fa-user-circle text-primary me-2"></i> 您的资料
                    </div>
                    <div class="card-body p-4">
                        <form id="profileForm">
                            <div class="mb-3 row">
                                <label for="username" class="col-sm-3 col-form-label fw-medium text-end">用户名</label>
                                <div class="col-sm-9">
                                    <input type="text" readonly class="form-control-plaintext" id="username"
                                        name="username" value="">
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="realName" class="col-sm-3 col-form-label fw-medium text-end">真实姓名</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="realName" name="realName">
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="phone" class="col-sm-3 col-form-label fw-medium text-end">手机号码</label>
                                <div class="col-sm-9">
                                    <input type="tel" class="form-control" id="phone" name="phone">
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="email" class="col-sm-3 col-form-label fw-medium text-end">邮箱地址</label>
                                <div class="col-sm-9">
                                    <input type="email" class="form-control" id="email" name="email">
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="remark" class="col-sm-3 col-form-label fw-medium text-end">备注</label>
                                <div class="col-sm-9">
                                    <textarea class="form-control" id="remark" name="remark" rows="3"></textarea>
                                </div>
                            </div>

                            <hr class="my-4 text-muted">

                            <div class="mb-4 row">
                                <label class="col-sm-3 col-form-label fw-medium text-end">修改密码</label>
                                <div class="col-sm-9">
                                    <input type="password" class="form-control" id="password" name="password"
                                        placeholder="若不修改请留空">
                                    <div class="form-text">密码长度至少6位，为了您的账号安全，建议定期修改。</div>
                                </div>
                            </div>

                            <div class="text-end">
                                <button type="submit" class="btn btn-primary px-4">
                                    <i class="fa fa-save me-1"></i> 保存更改
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function () {
                const profileForm = document.getElementById('profileForm');
                const apiProfileUrl = /*[[@{/api/users/profile}]]*/ '/admin/api/users/profile';

                // Load User Profile
                fetch(apiProfileUrl)
                    .then(response => response.json())
                    .then(res => {
                        if (res.code === 200) {
                            const user = res.data;
                            document.getElementById('username').value = user.username || '';
                            document.getElementById('realName').value = user.realName || '';
                            document.getElementById('phone').value = user.phone || '';
                            document.getElementById('email').value = user.email || '';
                            document.getElementById('remark').value = user.remark || '';
                        } else {
                            Toast.fire({
                                icon: 'error',
                                title: res.message || '加载用户信息失败'
                            });
                        }
                    })
                    .catch(err => {
                        console.error('Error loading profile:', err);
                        Toast.fire({
                            icon: 'error',
                            title: '无法连接到服务器'
                        });
                    });

                // Update Profile
                profileForm.addEventListener('submit', function (e) {
                    e.preventDefault();

                    const formData = new FormData(profileForm);
                    const data = Object.fromEntries(formData.entries());

                    // Filter out empty password if not provided
                    if (!data.password) {
                        delete data.password;
                    }

                    // Since we mocked ID 1 always, we don't strictly need ID in payload for PUT /profile
                    // The backend handles getting the current user.

                    fetch(apiProfileUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                        .then(response => response.json())
                        .then(res => {
                            if (res.code === 200) {
                                Toast.fire({
                                    icon: 'success',
                                    title: '保存成功'
                                });
                                // Optionally reload part of the page or just feedback is enough
                            } else {
                                Toast.fire({
                                    icon: 'error',
                                    title: res.message || '保存失败'
                                });
                            }
                        })
                        .catch(err => {
                            console.error('Error updating profile:', err);
                            Toast.fire({
                                icon: 'error',
                                title: '无法连接到服务器'
                            });
                        });
                });
            });
        </script>
    </section>
</body>

</html>